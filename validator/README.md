# Validator

`validator` æ˜¯ä¸€ä¸ªä¸º Go é…ç½®ç®¡ç†å’Œé«˜æ€§èƒ½åœºæ™¯å®šåˆ¶çš„éªŒè¯åº“å°è£…ã€‚å®ƒåŸºäºå¼ºå¤§çš„ [go-playground/validator](https://github.com/go-playground/validator) æ„å»ºï¼Œè§£å†³äº†é…ç½®åŠ è½½åœºæ™¯ä¸‹çš„ç—›ç‚¹ï¼Œå¹¶å¼•å…¥äº†**æ··åˆéªŒè¯æ¨¡å¼ï¼ˆHybrid Validation Modeï¼‰**ï¼Œæä¾›é«˜è¾¾ **30x - 100x** çš„æ€§èƒ½æå‡ã€‚

## ç‰¹æ€§ (Features)

*   **é…ç½®æ–‡ä»¶å‹å¥½ (Config Friendly)**: æ™ºèƒ½è§£ææ ‡ç­¾ä¼˜å…ˆçº§ (`mapstructure` > `json` > `yaml` > `field name`)ã€‚å®Œç¾é€‚é… Viperï¼Œè§£å†³äº† Viper ä½¿ç”¨ `mapstructure` æ ‡ç­¾è€ŒéªŒè¯å™¨é»˜è®¤åªè®¤ `json` çš„é—®é¢˜ã€‚
*   **å¼€ç®±å³ç”¨çš„å›½é™…åŒ– (I18n)**: å†…ç½®ä¸­æ–‡ (`zh`) å’Œè‹±æ–‡ (`en`) æ”¯æŒã€‚é”™è¯¯ä¿¡æ¯è‡ªåŠ¨ç¿»è¯‘ï¼Œæ‹’ç» "Switch Hell"ã€‚
*   **æ··åˆéªŒè¯æ¨¡å¼ (Hybrid Mode)**:
    *   **å¸¸è§„æ¨¡å¼**: ä½¿ç”¨ Tag åå°„ï¼Œå¼€å‘æ•ˆç‡é«˜ï¼Œé€‚åˆé…ç½®åŠ è½½ã€‚
    *   **æé€Ÿæ¨¡å¼**: å®ç° `SelfValidatable` æ¥å£ï¼Œè·³è¿‡åå°„ï¼Œæ€§èƒ½æå‡ä¸€ä¸ªæ•°é‡çº§ï¼Œé€‚åˆé«˜é¢‘ APIã€‚
*   **å®‰å…¨å¥å£®**: å®Œå–„çš„ `nil` æŒ‡é’ˆå’Œéç»“æ„ä½“æ£€æŸ¥ï¼Œé˜²æ­¢ Panicã€‚

## å®‰è£… (Installation)

```bash
go get github.com/oy3o/conf/validator
```

## å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. åŸºç¡€ç”¨æ³• (é…ç½®éªŒè¯)

é€‚åˆåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶çš„é…ç½®åŠ è½½ï¼Œä¼˜å…ˆä½¿ç”¨ Tag å®šä¹‰è§„åˆ™ã€‚

```go
package main

import (
    "fmt"
    "github.com/oy3o/conf/validator"
)

type Config struct {
    // è‡ªåŠ¨è¯†åˆ« mapstructure æ ‡ç­¾ï¼Œé”™è¯¯ä¿¡æ¯æ›´å‹å¥½
    Host string `mapstructure:"host" validate:"required"`
    Port int    `mapstructure:"port" validate:"min=1024"`
}

func main() {
    // åˆå§‹åŒ–éªŒè¯å™¨ï¼Œå¼€å¯ä¸­æ–‡ç¿»è¯‘
    v, _ := validator.New("zh")

    cfg := Config{Port: 80} // Host ç¼ºå¤±ï¼ŒPort é”™è¯¯

    if err := v.Validate(cfg); err != nil {
        // ç›´æ¥æ‰“å°é”™è¯¯
        fmt.Println(err)
    }
}
```

**è¾“å‡º:**
```text
validation failed:
 - host: hostä¸ºå¿…å¡«å­—æ®µ
 - port: portå¿…é¡»å¤§äºæˆ–ç­‰äº1024
```

### 2. æé€Ÿæ¨¡å¼ (é«˜æ€§èƒ½ API)

å¯¹äº QPS > 10k çš„çƒ­ç‚¹è·¯å¾„ï¼Œæˆ–è€…å­—æ®µæå¤šçš„ç»“æ„ä½“ï¼Œå¯ä»¥è®©ç»“æ„ä½“å®ç° `SelfValidatable` æ¥å£ã€‚`Validator` ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶è°ƒç”¨è¯¥æ–¹æ³•ï¼Œ**å®Œå…¨è·³è¿‡åå°„å¼€é”€**ã€‚

```go
// å®šä¹‰åœ¨çƒ­ç‚¹è·¯å¾„ä½¿ç”¨çš„ç»“æ„ä½“
type LoginRequest struct {
    Username string
    Password string
}

// å®ç° Validate æ–¹æ³•
func (r *LoginRequest) Validate() error {
    if len(r.Username) == 0 {
        return fmt.Errorf("username is required")
    }
    if len(r.Password) < 8 {
        return fmt.Errorf("password too short")
    }
    return nil
}

func main() {
    v, _ := validator.New()
    
    req := LoginRequest{Username: "admin"}
    
    // å†…éƒ¨ä¼šè‡ªåŠ¨è¿›è¡Œæ¥å£æ–­è¨€ï¼Œç›´æ¥è°ƒç”¨ r.Validate()
    // è€—æ—¶ä»…éœ€ ~4.5ns
    if err := v.Validate(req); err != nil {
        fmt.Println(err)
    }
}
```

## ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯• (Benchmarks)

æˆ‘ä»¬å¯¹æ¯”äº† **åå°„æ¨¡å¼ (Reflection)** å’Œ **æ¥å£æ¨¡å¼ (Interface)** çš„æ€§èƒ½å·®å¼‚ã€‚

**æµ‹è¯•ç¯å¢ƒ:**
*   **CPU**: 13th Gen Intel(R) Core(TM) i9-13900HX
*   **Go**: 1.2x

| åœºæ™¯ (Scenario) | æ¨¡å¼ (Mode) | è€—æ—¶ (ns/op) | å†…å­˜åˆ†é… (B/op) | æ€§èƒ½å·®è· |
| :--- | :--- | :--- | :--- | :--- |
| **éªŒè¯æˆåŠŸ (Success)** | Reflect (Tag) | 152.3 ns | 24 B | 1x |
| | **Interface (Fast)** | **4.5 ns** | **0 B** | **~33x Faster** |
| | Direct Call (Raw) | 0.45 ns | 0 B | - |
| **éªŒè¯å¤±è´¥ (Failure)** | Reflect (Tag) | 833.2 ns | 833 B | 1x |
| | **Interface (Fast)** | **21.5 ns** | **16 B** | **~40x Faster** |

### ğŸ’¡ æ€§èƒ½è§£è¯»
*   **æé€Ÿå“åº”**: æ¥å£æ¨¡å¼å°†éªŒè¯è€—æ—¶ä»å¾®ç§’çº§ï¼ˆ`us`ï¼‰å‹ç¼©åˆ°äº†çº³ç§’çº§ï¼ˆ`ns`ï¼‰ã€‚
*   **é›¶ GC**: åœ¨éªŒè¯é€šè¿‡çš„åœºæ™¯ä¸‹ï¼ˆè¿™ä¹Ÿæ˜¯ 99% çš„æƒ…å†µï¼‰ï¼Œæ¥å£æ¨¡å¼æ˜¯ **0 å†…å­˜åˆ†é…**ï¼Œå¯¹ GC æä¸ºå‹å¥½ã€‚
*   **è§„æ¨¡æ•ˆåº”**: éšç€ç»“æ„ä½“å­—æ®µæ•°é‡çš„å¢åŠ ï¼Œåå°„æ¨¡å¼çš„è€—æ—¶ä¼šçº¿æ€§å¢é•¿ï¼Œè€Œæ¥å£æ¨¡å¼ï¼ˆç¼–è¯‘ä¸ºæœºå™¨ç ï¼‰å‡ ä¹ä¿æŒæ’å®šï¼Œä¼˜åŠ¿å°†è¿›ä¸€æ­¥æ‰©å¤§è‡³ **100x** ä»¥ä¸Šã€‚

è¯·æ³¨æ„ **Direct Call (Raw)** çš„æ•°æ®ï¼ˆ0.45 nsï¼‰ã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå¯¹ç…§ç»„ï¼Œå®ƒæ­ç¤ºäº† Go å¯¹è±¡éªŒè¯çš„**æœ€ä½³å®è·µæŒ‡å¯¼**ï¼š

1.  **å°è£…çš„æˆæœ¬**: `v.Validate(req)` (4.5ns) ä¸ `req.Validate()` (0.45ns) ä¹‹é—´å­˜åœ¨çº¦ **4ns** çš„å·®è·ã€‚è¿™æºäº Go è¿è¡Œæ—¶çš„ `interface{}` ç±»å‹æ–­è¨€å’Œå‡½æ•°è°ƒç”¨å¼€é”€ã€‚
2.  **æ¶æ„å»ºè®®**: 
    *   åœ¨ **99% çš„ä¸šåŠ¡åœºæ™¯** ä¸‹ï¼Œä½¿ç”¨æœ¬åº“çš„ `v.Validate()` å°è£…ï¼Œå› ä¸ºå®ƒæä¾›äº†ç»Ÿä¸€çš„å…¥å£ã€é”™è¯¯å¤„ç†å’Œå›½é™…åŒ–ï¼Œè€Œ 4ns çš„å¼€é”€å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚
    *   åœ¨ **1% çš„æç«¯çƒ­ç‚¹å¾ªç¯**ï¼ˆå¦‚å¤„ç†åƒä¸‡çº§æ•°æ®çš„ç´§å¯†å¾ªç¯ï¼‰ä¸­ï¼Œä½ åº”è¯¥**ç»•è¿‡æœ¬åº“**ï¼Œç›´æ¥è°ƒç”¨ `obj.Validate()`ã€‚

**æœ¬åº“çš„è®¾è®¡å“²å­¦**ï¼šæä¾›ä¸€ä¸ªç»Ÿä¸€çš„é€‚é…å™¨ï¼Œè®©ä½ åœ¨â€œå¼€å‘ä¾¿åˆ©æ€§â€ï¼ˆReflectï¼‰ã€â€œé«˜æ€§èƒ½â€ï¼ˆInterfaceï¼‰å’Œâ€œæé™æ€§èƒ½â€ï¼ˆDirect Callï¼‰ä¹‹é—´è‡ªç”±é€‰æ‹©ï¼Œè€Œæ— éœ€æ›´æ¢åº“ã€‚

## ğŸ›  æœ€ä½³å®è·µ (Best Practices)

| åœºæ™¯ | æ¨èæ¨¡å¼ | ç†ç”± |
| :--- | :--- | :--- |
| **åŠ è½½é…ç½®æ–‡ä»¶** | **Tag (åå°„)** | åªåœ¨å¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡ï¼Œå¼€å‘æ•ˆç‡ä¼˜å…ˆï¼Œä»£ç ç®€æ´ã€‚ |
| **å¸¸è§„ HTTP API** | **Tag (åå°„)** | å¼€å‘ä¾¿æ·ï¼Œæ ¡éªŒé€»è¾‘å¯è§†åŒ–ã€‚å¾®ç§’çº§æŸè€—é€šå¸¸ä¸æ˜¯ç“¶é¢ˆã€‚ |
| **é«˜é¢‘ RPC / ç½‘å…³** | **Interface** | é€šè¿‡å®ç° `Validate()` æ–¹æ³•æ¶ˆé™¤åå°„å¼€é”€ã€‚ |
| **çƒ­ç‚¹ä»£ç è·¯å¾„** | **Direct Call** | ç›´æ¥è°ƒç”¨æ–¹æ³•ï¼Œé›¶ä¸­é—´å±‚æŸè€—ã€‚ |

## ğŸ§© API è¯´æ˜

### `New(locale ...string) (*Validator, error)`
åˆå§‹åŒ–éªŒè¯å™¨ã€‚
*   ä¸ä¼ å‚æ•°ï¼šé»˜è®¤ä¸å¼€å¯ç¿»è¯‘ï¼ˆæ€§èƒ½æœ€é«˜ï¼‰ã€‚
*   `"zh"`: å¼€å¯ä¸­æ–‡é”™è¯¯æç¤ºã€‚
*   `"en"`: å¼€å¯è‹±æ–‡é”™è¯¯æç¤ºã€‚

### `Validate(i interface{}) error`
æ‰§è¡ŒéªŒè¯ã€‚
1.  **Fast Path**: æ£€æŸ¥ `i` æ˜¯å¦å®ç°äº† `SelfValidatable` æ¥å£ï¼Œè‹¥æ˜¯åˆ™ç›´æ¥è°ƒç”¨ã€‚
2.  **Slow Path**: ä½¿ç”¨åå°„è§£æ tag è¿›è¡ŒéªŒè¯ã€‚
3.  è¿”å›çš„ `error` å¯èƒ½æ˜¯ `*ValidationError` (åŒ…å«è¯¦ç»†å­—æ®µ map) æˆ–æ™®é€š `error`ã€‚
